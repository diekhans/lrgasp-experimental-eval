#!/usr/bin/env python3

import argparse
import pandas as pd
from pycbio.sys import fileOps


def parseArgs():
    desc = """pull stats for paper from eval spreadsheet tsv, add joinAnnotSummary added consolidate information"""
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument("--transcriptTsv")
    parser.add_argument("evalTsv")
    parser.add_argument("statsTsv")
    return parser.parse_args()


def percent(n, total):
    if total == 0:
        return 0.0
    else:
        return round(100 * (n / total), 1)

def basicReport(evalDf, fh):
    fileOps.prRowv(fh, "genes", len(set(evalDf.gene)))
    fileOps.prRowv(fh, "targets", len(set(evalDf.target)))
    fileOps.prRowv(fh, "transcripts", len(set(evalDf.transcript)))

def gencodeReport(evalDf, fh):
    # pb row is first with gencode and category
    df = evalDf[(evalDf.plat == "pb")]
    knownDf = df[(df.gencode == "known")]
    novelDf = df[(df.gencode == "novel")]
    rejectedDf = df[(df.gencode == "rejected")]

    # GENCODE-known, N=XX:
    fileOps.prRowv(fh, "gencodeKnown", len(knownDf))

    # GENCODE-novel, N=XX:,
    fileOps.prRowv(fh, "gencodeNovel", len(novelDf))

    # GENCODE-suspect, N=XX:
    fileOps.prRowv(fh, "gencodeRejected", len(rejectedDf))

    # GENCODE-known validation rate, XX%
    fileOps.prRowv(fh, "gencodeKnowSupportRate",
                   percent(len(knownDf[knownDf.category != "unsupported"]),
                           len(knownDf)))

    # GENCODE-known that failed to validate n+XX
    fileOps.prRowv(fh, "gencodeKnowNotValidated",
                   percent(len(knownDf[knownDf.category == "unsupported"]),
                           len(knownDf)))

    # GENCODE-novel   validation rate, XX %
    fileOps.prRowv(fh, "gencodeNovelSupportRate",
                   percent(len(novelDf[novelDf.category == "supported"]),
                           len(novelDf)))

    # GENCODE-suspect validation rate of XX,
    fileOps.prRowv(fh, "gencodeRejectedSupportRate",
                   percent(len(rejectedDf[rejectedDf.category == "supported"]),
                           len(rejectedDf)))

    # GENCODE-suspect “validated” XX
    fileOps.prRowv(fh, "gencodeRejectedSupport",
                   len(rejectedDf[rejectedDf.category == "supported"]))

_supportRanks = {
    "supported": 1,
    "likely": 2,
    "unsupported": 3,
    "": 4
}

def squantiReport(evalDf, fh, transcriptTsv):
    # manatee doesn't have captrap
    isManatee = "capTrapPrepCount" not in evalDf.columns

    # pb is first line of experiment experiment, other stats are NaN if not squanti-evaluated
    df = evalDf[(evalDf.plat == "pb")].dropna(subset=("mediaCpm",))

    # convert category to key
    transDf = df.copy()
    transDf.insert(0, "rank", transDf.category.apply(lambda c: _supportRanks[c]))
    transDf.sort_values(["transcript", "rank"], inplace=True)
    transDf.drop_duplicates("transcript", inplace=True)

    # all consider novel in manatee due to poor annotation
    if isManatee:
        novelDf = transDf
    else:
        noveldf = transDf[transDf.transcript.str.startswith('N')]

    catCols = [c for c in ["longOnlyCatCount", "longShortCatCount", "freeStyleCatCount"]
               if c in novelDf.columns]
    pc = novelDf.loc[:, catCols].sum(axis=1).copy().convert_dtypes()
    novelDf.insert(len(novelDf.columns), 'pipeLineCount', pc)

    # novel isoforms count:
    fileOps.prRowv(fh, "novelIsoforms", len(novelDf))

    # novel isoforms detected in N pipelines (different cuttons)
    # novel isoforms in less name N pipelines
    maxNp = int(novelDf.pipeLineCount.max())
    fileOps.prRowv(fh, "maxPipelines", maxNp)

    # split number of transcripts into at last 1/4

    for np in range(1, maxNp + 1, maxNp // 4):
        fileOps.prRowv(fh, "novelPipelineCnt_ge_" + str(np), len(novelDf[novelDf.pipeLineCount >= np]))
        fileOps.prRowv(fh, "novelPipelineCnt_lt_" + str(np), len(novelDf[novelDf.pipeLineCount < np]))

    if transcriptTsv is not None:
        # don't include these eval counts are not summed
        drop = ["rank", "plat", "chain", "chain_in2", "sim_100", "sim_98", "sim_95", "indel_0", "indel_2", "notes"]
        transDf.drop(drop, axis=1).to_csv(transcriptTsv, index=False, sep="\t")


def report(evalDf, fh, transcriptTsv):
    fileOps.prRowv(fh, "name", "value")
    basicReport(evalDf, fh)
    if "longOnlyCatCount" in evalDf.columns:
        squantiReport(evalDf, fh, transcriptTsv)
    if 'gencode' in evalDf.columns:
        gencodeReport(evalDf, fh)


def paperEvalStats(evalTsv, statsTsv, transcriptTsv):
    evalDf = pd.read_table(evalTsv)
    evalDf = evalDf.convert_dtypes()  # make ints ints rather than floats
    with open(statsTsv, 'w') as fh:
        report(evalDf, fh, transcriptTsv)

def main(opts):
    paperEvalStats(opts.evalTsv, opts.statsTsv, opts.transcriptTsv)

main(parseArgs())
