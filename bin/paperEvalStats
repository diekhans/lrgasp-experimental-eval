#!/usr/bin/env python3

import argparse
import pandas as pd
from pycbio.sys import fileOps
from evalLib import percent, filterToTranscript, splitBySquantiCategory, splitBySupport, addStructuralCategory

def parseArgs():
    desc = """pull stats for paper from eval spreadsheet tsv"""
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument("evalTsv")
    parser.add_argument("statsTsv")
    opts = parser.parse_args()
    return opts


def basicReport(evalDf, fh):
    fileOps.prRowv(fh, "genes", len(set(evalDf.gene)))
    fileOps.prRowv(fh, "targets", len(set(evalDf.target)))
    fileOps.prRowv(fh, "transcripts", len(set(evalDf.transcript)))

def reportSupportRate(fh, labelPrefix, subsetDf):
    supportedDf, unsupportedDf = splitBySupport(subsetDf)
    fileOps.prRowv(fh, labelPrefix + "Count", len(subsetDf))
    fileOps.prRowv(fh, labelPrefix + "Supported", len(supportedDf))
    fileOps.prRowv(fh, labelPrefix + "SupportedRate",
                   percent(len(supportedDf), len(subsetDf)))
    fileOps.prRowv(fh, labelPrefix + "Unsupported", len(unsupportedDf))
    fileOps.prRowv(fh, labelPrefix + "UnsupportedRate",
                   percent(len(unsupportedDf), len(subsetDf)))

def gencodeReport(transDf, fh):
    # pb row is first with gencode and category
    knownDf = transDf[(transDf.gencode == "known")]
    novelDf = transDf[(transDf.gencode == "novel")]
    rejectedDf = transDf[(transDf.gencode == "rejected")]
    if len(knownDf) + len(novelDf) + len(rejectedDf) != len(transDf):
        raise Exception("logic error splitting gencode transcripts")

    reportSupportRate(fh, "gencodeAll", transDf)
    reportSupportRate(fh, "gencodeKnown", knownDf)
    reportSupportRate(fh, "gencodeNovel", novelDf)
    reportSupportRate(fh, "gencodeRejected", rejectedDf)


def squantiReport(transDf, fh):
    knownDf, novelDf, ismDf, otherDf = splitBySquantiCategory(transDf)

    reportSupportRate(fh, "all", transDf)
    reportSupportRate(fh, "known", knownDf)
    reportSupportRate(fh, "novel", novelDf)
    reportSupportRate(fh, "ism", ismDf)
    reportSupportRate(fh, "other", otherDf)


def report(evalDf, fh):
    fileOps.prRowv(fh, "name", "value")
    basicReport(evalDf, fh)
    transDf = filterToTranscript(evalDf)
    if 'gencode' in evalDf.columns:
        gencodeReport(transDf, fh)
    else:
        squantiReport(transDf, fh)

def paperEvalStats(evalTsv, statsTsv):
    evalDf = pd.read_table(evalTsv)
    evalDf = evalDf.convert_dtypes()  # make ints ints rather than floats
    addStructuralCategory(evalDf)
    with open(statsTsv, 'w') as fh:
        report(evalDf, fh)

def main(opts):
    paperEvalStats(opts.evalTsv, opts.statsTsv)

main(parseArgs())
